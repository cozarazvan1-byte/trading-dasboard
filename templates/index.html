<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trading Dashboard PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --glass-surface: rgba(30, 41, 59, 0.75); /* Mai opac pentru contrast */
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent: #38bdf8; --win: #10b981; --loss: #f43f5e;
            --text-main: #f1f5f9; --text-muted: #94a3b8;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Inter', sans-serif; 
            background: radial-gradient(circle at top left, #1e1b4b, #0f172a);
            color: var(--text-main); 
            margin: 0; padding-bottom: 80px; /* Spatiu pt butoane jos */
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- AUTH SCREEN --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            z-index: 1000; padding: 20px;
        }
        .auth-card {
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border); padding: 2rem; border-radius: 24px;
            width: 100%; max-width: 400px; text-align: center;
        }
        .auth-title { font-size: 1.8rem; font-weight: 800; margin-bottom: 0.5rem; color: white; }
        .modern-input { width: 100%; padding: 12px; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); border-radius: 12px; color: white; margin-bottom: 15px; }
        .btn-auth { width: 100%; padding: 14px; background: var(--accent); color: #0f172a; border: none; border-radius: 12px; font-weight: 800; }

        /* --- DASHBOARD --- */
        #dashboard { display: none; padding: 15px; max-width: 1600px; margin: auto; }

        /* Header Responsive */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 15px; }
        .brand { font-size: 1.3rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        
        .balance-config { display: flex; flex-direction: column; align-items: flex-end; }
        .balance-label { font-size: 0.65rem; color: var(--text-muted); font-weight: bold; margin-bottom: 2px; }
        .balance-input { background: var(--glass-surface); border: 1px solid var(--glass-border); color: var(--accent); font-weight: 800; padding: 6px 10px; border-radius: 8px; width: 100px; text-align: right; font-size: 0.9rem; }
        
        .user-pill { background: var(--glass-surface); padding: 6px 12px; border-radius: 50px; font-size: 0.8rem; border: 1px solid var(--glass-border); display: flex; align-items: center; gap: 8px; }
        .btn-logout { background: var(--loss); color: white; border: none; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; }

        /* Stats Grid - Responsive */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 2rem; }
        .stat-card {
            background: var(--glass-surface); border: 1px solid var(--glass-border); border-radius: 16px; padding: 15px;
            display: flex; flex-direction: column; justify-content: center; text-align: center;
        }
        .stat-val { font-size: 1.5rem; font-weight: 800; margin-top: 5px; }
        .stat-lbl { color: var(--text-muted); font-size: 0.65rem; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }

        /* Table - Scroll Orizontal Fluid */
        .table-glass { 
            background: var(--glass-surface); border: 1px solid var(--glass-border); border-radius: 16px; 
            overflow: hidden; padding: 5px; margin-bottom: 60px;
        }
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; max-height: 60vh; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 800px; /* AsigurÄƒ cÄƒ tabelul nu se strÃ¢nge */ }
        th { 
            text-align: left; padding: 12px; color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; 
            border-bottom: 1px solid var(--glass-border); position: sticky; top: 0; background: #131c31; z-index: 10;
        }
        td { padding: 12px; color: var(--text-main); font-size: 0.85rem; border-bottom: 1px solid rgba(255,255,255,0.03); white-space: nowrap; }
        
        /* Input-uri Tabel */
        .tbl-input { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; padding: 6px; border-radius: 6px; width: 100%; font-size: 0.85rem; }

        /* Progress Bars */
        .track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .fill { height: 100%; border-radius: 10px; width: 0%; transition: width 1s ease; }

        /* Colors & Badges */
        .win-txt { color: var(--win); font-weight: 700; }
        .loss-txt { color: var(--loss); font-weight: 700; }
        .badge { padding: 3px 8px; border-radius: 4px; font-weight: 700; font-size: 0.7rem; }
        .badge-buy { background: rgba(56, 189, 248, 0.15); color: #38bdf8; }
        .badge-sell { background: rgba(244, 63, 94, 0.15); color: #fb7185; }

        /* Floating Buttons */
        .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 8px; z-index: 100; align-items: flex-end; }
        .fab {
            background: var(--accent); color: #0f172a; width: 55px; height: 55px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: bold; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: none;
        }
        .fab-secondary {
            background: rgba(30, 41, 59, 0.9); border: 1px solid var(--glass-border); color: white;
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1rem; backdrop-filter: blur(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* MEDIA QUERIES PENTRU TELEFON */
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: stretch; gap: 20px; text-align: center; }
            .brand { justify-content: center; margin-bottom: 10px; }
            .header-controls { justify-content: space-between; width: 100%; }
            .stats-container { grid-template-columns: 1fr 1fr; /* 2 coloane pe mobil */ }
            #dashboard { padding: 10px; }
            .stat-val { font-size: 1.2rem; }
            .auth-card { padding: 1.5rem; }
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <div class="auth-title">Trading Dashboard</div>
            <div style="color:#94a3b8; margin-bottom:20px; font-size:0.9rem;">Acces Mobil & Desktop</div>
            
            <input type="text" id="username" class="modern-input" placeholder="User">
            <input type="password" id="password" class="modern-input" placeholder="Parola">
            <p id="auth-msg" style="color: var(--loss); font-size: 0.8rem; min-height: 20px;"></p>

            <button class="btn-auth" onclick="handleAuth()">LOGIN / REGISTER</button>
            <div style="margin-top:15px; font-size:0.8rem; color:#94a3b8; cursor:pointer;" onclick="toggleAuthMode()" id="auth-switch-text">Nu ai cont? CreeazÄƒ unul</div>
        </div>
    </div>

    <div id="dashboard">
        <div class="header">
            <div class="brand">ðŸš€ Trading Dashboard</div>
            <div class="header-controls">
                <div class="balance-config">
                    <span class="balance-label">BALANÈšA</span>
                    <input type="number" id="start-balance" class="balance-input" value="10000" onchange="saveConfig()">
                </div>
                <div class="user-pill">
                    <span id="user-display">User</span>
                    <button class="btn-logout" onclick="logout()">EXIT</button>
                </div>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <span class="stat-lbl">Equity</span>
                <span id="stat-equity" class="stat-val">$0.00</span>
            </div>
            <div class="stat-card">
                <span class="stat-lbl">P/L (%)</span>
                <span id="stat-pl" class="stat-val">0.00%</span>
            </div>
            <div class="stat-card">
                <span class="stat-lbl">Win Rate</span>
                <span id="stat-wr" class="stat-val" style="color: var(--accent);">0%</span>
            </div>
            <div class="stat-card" style="grid-column: span 2; text-align:left;"> 
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span class="stat-lbl">DD: <span id="dd-val" style="color:white;">0%</span></span>
                    <span class="stat-lbl">Target: <span id="pt-val" style="color:white;">0%</span></span>
                </div>
                <div class="track"><div id="dd-bar" class="fill" style="background: var(--loss);"></div></div>
                <div class="track" style="margin-top:8px;"><div id="pt-bar" class="fill" style="background: var(--win);"></div></div>
            </div>
        </div>

        <div class="table-glass">
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th> <th>Pair</th> <th>Dir</th> <th>Risc</th> <th>RR</th> <th>P/L</th> <th>Obs</th> <th>Link</th> <th></th>
                        </tr>
                    </thead>
                    <tbody id="input-area"></tbody>
                    <tbody id="trade-body"></tbody>
                </table>
            </div>
        </div>
        
        <div class="fab-container">
            <button class="fab-secondary" onclick="exportExcel()" title="Excel">ðŸ“Š</button>
            <button class="fab-secondary" onclick="addSeparator()" title="LunÄƒ">ðŸ“…</button>
            <button class="fab" onclick="showInputRow()" title="AdaugÄƒ">+</button>
        </div>
    </div>

<script>
    let isLoginMode = true;
    let token = localStorage.getItem('token'); 
    const API_URL = "/api";

    /* CONFIG */
    let savedBalance = localStorage.getItem('startBalance');
    if(savedBalance) { document.getElementById('start-balance').value = savedBalance; }
    function saveConfig() { localStorage.setItem('startBalance', document.getElementById('start-balance').value); loadTrades(); }

    if(token) showDashboard();

    /* AUTH */
    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        document.querySelector('.btn-auth').innerText = isLoginMode ? "LOGIN" : "REGISTER";
        document.getElementById('auth-switch-text').innerText = isLoginMode ? "Nu ai cont? CreeazÄƒ unul" : "Ai cont? LogheazÄƒ-te";
    }

    async function handleAuth() {
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        const msg = document.getElementById('auth-msg');

        if(!user || !pass) { msg.innerText = "CompleteazÄƒ datele!"; return; }
        
        const endpoint = isLoginMode ? "/login" : "/register";
        try {
            const response = await fetch(API_URL + endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: user, password: pass }) });
            const data = await response.json();
            if(!response.ok) throw new Error(data.detail || "Eroare server");

            if(isLoginMode) {
                localStorage.setItem('token', data.access_token);
                localStorage.setItem('user', user);
                token = data.access_token;
                showDashboard();
            } else {
                alert("Cont creat! Acum te poÈ›i loga.");
                toggleAuthMode();
            }
        } catch (err) { msg.innerText = err.message; }
    }

    function showDashboard() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('user-display').innerText = localStorage.getItem('user');
        loadTrades();
    }
    function logout() { localStorage.removeItem('token'); localStorage.removeItem('user'); location.reload(); }

    /* DATA */
    let allTradesCache = [];
    async function loadTrades() {
        if(!token) return;
        const res = await fetch(API_URL + '/trades/', { headers: { 'Authorization': 'Bearer ' + token } });
        if(res.status === 401) { logout(); return; }

        const trades = await res.json();
        allTradesCache = trades;
        const body = document.getElementById('trade-body');
        body.innerHTML = '';
        
        let startBalance = parseFloat(document.getElementById('start-balance').value) || 10000;
        let equity = startBalance;
        let totalPL = 0; let wins = 0; let tradeCount = 0;

        trades.forEach(t => {
            let isImport = t.pair.toUpperCase() === "IMPORT";
            let isSeparator = t.pair === "SEPARATOR";
            if (!isSeparator) { totalPL += t.pl; equity += t.pl; }
            if (!isImport && !isSeparator) { tradeCount++; if (t.pl > 0) wins++; }

            if (isSeparator) {
                body.innerHTML += `<tr><td colspan="8" style="background:rgba(56,189,248,0.1);text-align:center;color:var(--accent);font-weight:800;letter-spacing:1px;padding:10px;">ðŸ“… ${t.obs}</td><td><button style="border:none;background:none;color:var(--loss);" onclick="deleteTrade(${t.id})">Ã—</button></td></tr>`;
                return;
            }

            let badge = t.direction === 'BUY' ? `<span class="badge badge-buy">BUY</span>` : `<span class="badge badge-sell">SELL</span>`;
            let percent = (t.pl / startBalance) * 100;
            let plSign = percent > 0 ? '+' : '';
            let plClass = percent >= 0 ? 'win-txt' : (isImport ? 'text-muted' : 'loss-txt');
            let linkIcon = (t.link && t.link.length > 5) ? `<a href="${t.link}" target="_blank" style="text-decoration:none">ðŸ”—</a>` : `<span style="opacity:0.2">ðŸ”—</span>`;

            body.innerHTML += `
                <tr style="${isImport ? 'opacity:0.7; font-style:italic;' : ''}">
                    <td style="color:#94a3b8;font-size:0.75rem;">${t.date.substring(5)}</td>
                    <td style="font-weight:700;">${t.pair}</td>
                    <td>${badge}</td>
                    <td>${t.risk}</td>
                    <td>${t.rr}</td>
                    <td class="${plClass}">${plSign}${percent.toFixed(2)}%</td>
                    <td style="font-size:0.8rem;color:#94a3b8;">${t.obs}</td>
                    <td style="text-align:center;">${linkIcon}</td>
                    <td><button style="border:none;background:none;color:var(--loss);" onclick="deleteTrade(${t.id})">Ã—</button></td>
                </tr>`;
        });

        document.getElementById('stat-equity').innerText = `$${equity.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0})}`;
        let totalPLPercent = (totalPL / startBalance) * 100;
        let plSign = totalPLPercent > 0 ? '+' : '';
        document.getElementById('stat-pl').innerText = `${plSign}${totalPLPercent.toFixed(2)}%`;
        document.getElementById('stat-pl').className = "stat-val " + (totalPLPercent >= 0 ? 'win-txt' : 'loss-txt');

        let wr = tradeCount > 0 ? ((wins / tradeCount) * 100).toFixed(1) : 0;
        document.getElementById('stat-wr').innerText = wr + '%';

        let growth = ((equity - startBalance) / startBalance) * 100;
        if(growth < 0) {
            document.getElementById('dd-bar').style.width = Math.min(Math.abs(growth)*10, 100) + "%";
            document.getElementById('dd-val').innerText = growth.toFixed(2) + "%";
        } else {
            document.getElementById('pt-bar').style.width = Math.min(growth*10, 100) + "%";
            document.getElementById('pt-val').innerText = "+" + growth.toFixed(2) + "%";
        }
    }

    /* ACTIONS */
    function showInputRow() {
        const area = document.getElementById('input-area');
        if(area.innerHTML) return;
        const today = new Date().toISOString().split('T')[0];
        area.innerHTML = `
            <tr style="background:rgba(56,189,248,0.1);">
                <td><input id="n-date" type="date" value="${today}" class="tbl-input" style="width:110px;"></td>
                <td><input id="n-pair" placeholder="EURUSD" class="tbl-input" style="text-transform:uppercase;width:70px;"></td>
                <td><select id="n-dir" class="tbl-input"><option>BUY</option><option>SELL</option></select></td>
                <td><input id="n-risk" value="1%" class="tbl-input" style="width:40px;"></td>
                <td><input id="n-rr" value="1:2" class="tbl-input" style="width:40px;"></td>
                <td><input id="n-pl" type="number" placeholder="$" class="tbl-input" style="width:60px;"></td>
                <td><input id="n-obs" placeholder="..." class="tbl-input"></td>
                <td><input id="n-link" placeholder="URL" class="tbl-input"></td>
                <td><button style="color:var(--win);border:none;background:none;font-size:1.2rem;" onclick="saveNewTrade()">âœ“</button></td>
            </tr>`;
    }

    async function saveNewTrade() {
        const pair = document.getElementById('n-pair').value;
        if(!pair) return;
        const trade = {
            date: document.getElementById('n-date').value, pair: pair.toUpperCase(), direction: document.getElementById('n-dir').value,
            risk: document.getElementById('n-risk').value, rr: document.getElementById('n-rr').value, pl: parseFloat(document.getElementById('n-pl').value || 0),
            obs: document.getElementById('n-obs').value, link: document.getElementById('n-link').value || "#"
        };
        await fetch(API_URL + '/trades/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(trade) });
        document.getElementById('input-area').innerHTML = ''; loadTrades();
    }

    async function addSeparator() {
        const m = ["Ian", "Feb", "Mar", "Apr", "Mai", "Iun", "Iul", "Aug", "Sep", "Oct", "Noi", "Dec"];
        const txt = prompt("LunÄƒ:", m[new Date().getMonth()]);
        if(!txt) return;
        await fetch(API_URL + '/trades/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, 
        body: JSON.stringify({ date: "", pair: "SEPARATOR", direction: "-", risk: "-", rr: "-", pl: 0, obs: txt, link: "" }) });
        loadTrades();
    }

    function exportExcel() {
        if(!allTradesCache.length) { alert("Nu ai date!"); return; }
        let csv = "data:text/csv;charset=utf-8,Data,Pereche,Dir,Risc,RR,PL($),Obs,Link\n";
        allTradesCache.forEach(t => { if(t.pair!=="SEPARATOR") csv += `${t.date},${t.pair},${t.direction},${t.risk},${t.rr},${t.pl},"${t.obs}",${t.link}\n`; });
        const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "jurnal.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    async function deleteTrade(id) { if(confirm("È˜tergi?")) { await fetch(API_URL + `/trades/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } }); loadTrades(); } }
</script>
</body>
</html>
